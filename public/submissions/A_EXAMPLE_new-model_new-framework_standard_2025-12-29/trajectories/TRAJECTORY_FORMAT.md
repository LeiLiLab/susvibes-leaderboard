# `*.trials.json` File Format Specification

## File Structure Overview

```json
[
  {
    "instance_id": "string",
    "model_patch": "string",
    "trajectory": [ /* event array */ ]
  },
  // ... more instances
]
```

The file is a **JSON array**, where each element represents the complete execution record of a task instance.

---

## Top-Level Fields

| Field | Type | Description |
|------|------|------|
| `instance_id` | string | Unique task identifier, recommended format: `owner__repo_commitHash` |
| `model_patch` | string | Code patch generated by the Agent (diff format) |
| `trajectory` | array | Event array recording the complete conversation history |

---

## Trajectory Event Types

Each element in the `trajectory` array is an event object. The code supports **4 `type` values**:

### 1. `type: "system"` - Initialization Event (Optional)

Used to record session initialization information, **does not generate a visualization message**.

```json
{
  "type": "system",
  "timestamp": "2025-01-10T12:00:00Z",
  "model": "claude-sonnet-4-20250514"
}
```

| Field | Type | Required | Description |
|------|------|------|------|
| `type` | string | ‚úÖ | Must be `"system"` |
| `timestamp` | string | ‚ùå | ISO 8601 format, used to calculate start time |
| `model` | string | ‚ùå | Model name, used to display Agent information |

---

### 2. `type: "assistant"` - Agent Response Event

**This is the most important event type**, generates a **ü§ñ Agent** visualization message.

```json
{
  "type": "assistant",
  "timestamp": "2025-01-10T12:00:05Z",
  "message": {
    "role": "assistant",
    "content": [
      {
        "type": "text",
        "text": "Let me help you analyze this problem..."
      },
      {
        "type": "tool_use",
        "id": "toolu_abc123",
        "name": "Bash",
        "input": {
          "command": "ls -la"
        }
      }
    ],
    "usage": {
      "input_tokens": 1500,
      "output_tokens": 200
    },
    "cost": 0.0125
  }
}
```

| Field | Type | Required | Description |
|------|------|------|------|
| `type` | string | ‚úÖ | Must be `"assistant"` |
| `timestamp` | string | ‚ùå | ISO 8601 format |
| `message` | object | ‚úÖ | Message content object |
| `message.role` | string | ‚ùå | Defaults to `"assistant"` |
| `message.content` | array \| string | ‚úÖ | Message content (see details below) |
| `message.usage` | object | ‚ùå | Token usage statistics |
| `message.cost` | number | ‚ùå | Cost of this call (USD) |

---

### 3. `type: "user"` - User/Tool Result Event

Used to record user input or tool execution results, generates **üë§ User** or **üîß Tool Output** visualization messages.

```json
{
  "type": "user",
  "timestamp": "2025-01-10T12:00:06Z",
  "message": {
    "role": "user",
    "content": [
      {
        "type": "tool_result",
        "tool_use_id": "toolu_abc123",
        "content": "total 32\ndrwxr-xr-x  5 user user 4096 Jan 10 12:00 .\n..."
      }
    ]
  }
}
```

**To display as üîß Tool Output**, set `message.role` to `"tool"`:

```json
{
  "type": "user",
  "message": {
    "role": "tool",
    "content": [
      {
        "type": "tool_result",
        "tool_use_id": "toolu_abc123",
        "content": "Command executed successfully..."
      }
    ]
  }
}
```

| Field | Type | Required | Description |
|------|------|------|------|
| `type` | string | ‚úÖ | Must be `"user"` |
| `timestamp` | string | ‚ùå | ISO 8601 format |
| `message` | object | ‚úÖ | Message content object |
| `message.role` | string | ‚ùå | `"user"` ‚Üí üë§ User; `"tool"` ‚Üí üîß Tool Output |
| `message.content` | array \| string | ‚úÖ | Message content |

---

### 4. `type: "result"` - Result Event (Optional)

Used to record the final result information of task execution, **does not generate a visualization message**.

```json
{
  "type": "result",
  "subtype": "completed",
  "duration_ms": 120000,
  "total_cost_usd": 0.156,
  "num_turns": 25,
  "is_error": false
}
```

| Field | Type | Required | Description |
|------|------|------|------|
| `type` | string | ‚úÖ | Must be `"result"` |
| `subtype` | string | ‚ùå | Termination reason, e.g., `"completed"`, `"max_turns"`, etc. |
| `duration_ms` | number | ‚ùå | Total duration (milliseconds) |
| `total_cost_usd` | number | ‚ùå | Total cost (USD) |
| `num_turns` | number | ‚ùå | Number of conversation turns |
| `is_error` | boolean | ‚ùå | Whether terminated due to error |

---

## `message.content` Details

`content` can be a **string** or **array**. Array format is recommended to support tool calls:

### Supported content subtypes

| `content[].type` | Description | Extraction method |
|------------------|------|----------|
| `"text"` | Text content | Extract `.text` field |
| `"tool_use"` | Tool call | Extract to `tool_calls` array for separate display |
| `"tool_result"` | Tool return result | Extract `.content` field |
| Plain string | Direct text | Use directly |
| Other | Unknown type | `JSON.stringify()` serialization display |

### Content subtype examples

**Text content:**
```json
{ "type": "text", "text": "Let me analyze this problem..." }
```

**Tool call:**
```json
{
  "type": "tool_use",
  "id": "toolu_abc123",
  "name": "Read",
  "input": {
    "file_path": "/src/main.py"
  }
}
```

**Tool result:**
```json
{
  "type": "tool_result",
  "tool_use_id": "toolu_abc123",
  "content": "File content..."
}
```

---

## `message.usage` Details

Token usage statistics, supports two field naming conventions:

```json
{
  "usage": {
    "input_tokens": 1500,      // or "prompt_tokens"
    "output_tokens": 200       // or "completion_tokens"
  }
}
```

---

## Complete Example

```json
[
  {
    "instance_id": "django__django_abc123def456",
    "model_patch": "diff --git a/django/core/handlers.py b/django/core/handlers.py\n...",
    "trajectory": [
      {
        "type": "system",
        "timestamp": "2025-01-10T12:00:00Z",
        "model": "claude-sonnet-4-20250514"
      },
      {
        "type": "assistant",
        "timestamp": "2025-01-10T12:00:01Z",
        "message": {
          "role": "assistant",
          "content": [
            {
              "type": "text",
              "text": "Let me check the relevant files."
            },
            {
              "type": "tool_use",
              "id": "toolu_001",
              "name": "Read",
              "input": { "file_path": "/django/core/handlers.py" }
            }
          ],
          "usage": { "input_tokens": 500, "output_tokens": 50 },
          "cost": 0.003
        }
      },
      {
        "type": "user",
        "timestamp": "2025-01-10T12:00:02Z",
        "message": {
          "role": "tool",
          "content": [
            {
              "type": "tool_result",
              "tool_use_id": "toolu_001",
              "content": "from django.core import signals\n..."
            }
          ]
        }
      },
      {
        "type": "assistant",
        "timestamp": "2025-01-10T12:00:05Z",
        "message": {
          "role": "assistant",
          "content": [
            {
              "type": "text",
              "text": "I found the issue, need to fix line 42..."
            },
            {
              "type": "tool_use",
              "id": "toolu_002",
              "name": "Edit",
              "input": {
                "file_path": "/django/core/handlers.py",
                "old_string": "buggy_code()",
                "new_string": "fixed_code()"
              }
            }
          ],
          "usage": { "input_tokens": 800, "output_tokens": 120 },
          "cost": 0.005
        }
      },
      {
        "type": "user",
        "timestamp": "2025-01-10T12:00:06Z",
        "message": {
          "role": "tool",
          "content": [
            {
              "type": "tool_result",
              "tool_use_id": "toolu_002",
              "content": "File edited successfully."
            }
          ]
        }
      },
      {
        "type": "result",
        "subtype": "completed",
        "duration_ms": 6000,
        "total_cost_usd": 0.008,
        "num_turns": 4,
        "is_error": false
      }
    ]
  }
]
```

---

## Visualization Display Rules Summary

| Event type | message.role | Displayed as | Generates message |
|-----------|--------------|--------|-------------|
| `"system"` | - | - | ‚ùå No |
| `"result"` | - | - | ‚ùå No |
| `"assistant"` | `"assistant"` or none | ü§ñ Agent | ‚úÖ |
| `"user"` | `"user"` or none | üë§ User | ‚úÖ |
| `"user"` | `"tool"` | üîß Tool Output | ‚úÖ |


